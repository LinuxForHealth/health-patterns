# github actions documentation

There are a number of workflows that are defined here.  Each is described in more detail below.

### health-patterns-build-action.yml
This build action will automate the process of building services and maintaining helm charts when changes are made to the underlying files in the service.  The action relies on two scripts to build individual services and to collect, commit and push all changed files.

These scripts are `build-health-patterns.sh` and `build-service.sh`.

#### build-service.sh

This script is responsible for building out the support for an individual service.  The steps include:

1. Build a service from source
1. Generate a docker container
1. Push the docker container to a container registry
1. Update helm charts referencing the docker container
1. Rebuild the helm package
1. Reindex the helm repository
1. Update the Health Patterns Helm chart to target the new service Helm chart

In addition, this script can be used in `DEV` mode to allow the developer to update the deployment environment necessary to test changes being made to a service via the health patterns ingestion or enrichment flow. (Note that the index and helm chart versions are not changed in this case since that is not necessary for local deployment)

For example, to test a change to the `fhir-trigger` service as part of a deployment, you can issue the command

```
.github/workflows/scripts/build-service.sh \
-s=fhir-trigger \
-m=DEV \
--github-user=<your github username> \
--private-docker-user=<your docker username if different from github> \
--private-docker-token=<your docker token to allow pushing of image to your private dockerhub registry>
```

Once the container has been rebuilt and pushed, the helm chart `values.yaml` has been updated with the new image/version and the helm chart package has been rebuilt and copied to the local repository, a helm deploy can be done using the local `helm install` command as described in the ingest or enrich READMEs.

#### build-health-patterns.sh
This script is responsible for gathering all changed files, committing them, and then pushing those changes to github.

### ibm.yaml
This action will: 
1. Create a test namespace in the health-patterns-1 cluster in the IBM Cloud. 
1. Deploy a basic ingestion configuration in the test namespace.   
1. Build and execute basic ingestion and enrichment tests.
1. Clean up the deployment and namespace.

### maven.yml
This action performs maven builds for a few of the services.

### superlinter.yaml
**superlinter** is a github action that will invoke a variety of linters against files in the code base.  Currently, python files are linted using flake8, mypy, isort, and pylint.  Dockerfiles are also validated.  Errors that are detected are logged but do not cause a build failure.

It is possible to run the superlinting process locally in your current directory. The result will be a file called  `super-linter.log` that contains errors and warnings generated by the various linters.  Environment variables control the docker execution.

```
docker run \
-e RUN_LOCAL=true \
-e USE_FIND_ALGORITHM=true \
-e VALIDATE_PYTHON_FLAKE8=true \
-e VALIDATE_PYTHON_ISORT=true \
-e VALIDATE_PYTHON_MYPY=true \
-e VALIDATE_PYTHON_PYLINT=true \
-e VALIDATE_DOCKERFILE=true \
-v $PWD:/tmp/lint \
github/super-linter:slim-v4
```
